<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Example SMART App</title>
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <style>
            /* #patient, #extended_patient, #obs {
                font-family: Monaco, monospace;
                white-space: pre;
                font-size: 13px;
                height: 30vh;
                overflow: scroll;
                border: 1px solid #CCC;
            } */

            .maxWidth {
                max-width: 800px;
            }
            /* .border1px {
                border: 1px solid;
            } */
            .center {
                margin: auto;
            }
        </style>
    </head>
    <body>
        <div class="container border1px">
            <div style="display:flex; flex-direction: row; justify-content: center; align-items: center">
                <div>
                    <h1>Thyroid Tracker</h1>
                    <h5> Hi Thang Tran</h5>
                </div>
                <div>
                    <img src="https://www.niddk.nih.gov/-/media/Images/Health-Information/Endocrine-Diseases/ThyroidAnatomy_758x864.jpg" class="img-thumbnail" alt="..." style="width: auto; height: 150px">
                </div>
            </div>

            <div class="maxWidth center" style="display:flex; flex-direction: row; justify-content: space-between">
  
                <div class="border1px">
                    <div class="maxWidth border1px ">
                        <h5 class="border1px">Medications</h4>
                        <ul>
                            <li>Methiazole 5 mg</li>
                            <li>Propanolol 20 mg</li>
                        </ul>
                    </div>    
        
                    <div class="maxWidth border1px center">
                        <h5 class="border1px">Appoinment & Lab order</h4>
                        <ul><li>Next Visit: 2024-04-18</li></ul>
                        <!-- <p>Next Lab order: 2024-04-18</p> -->
                    </div>     
                </div>

                <div class="maxWidth border1px center">
                    <h4>Bio info</h4>
                    <ul>
                        <li>Full name: Thang Tran</li> 
                        <li>Gender: Male</li>
                        <li>DoB: 03/08/1992</li>
                        <li>Address: Phoenix, AZ</li>    
                    </ul>
                    
                </div>

                    

            </div>

                        

            <div class="maxWidth border1px center">
                <h5>TSH status</h4>
                <!-- <div id="obs">Loading...</div> -->
                <form action="/action_page.php" style="display: flex; flex-direction: row">
                    <label for="datePrompt">Date:</label>
                    <input type="text" id="date" name="date"><br><br>
                    <label for="tshPrompt">TSH:</label>
                    <input type="text" id="tsh" name="tsh"><br><br>
                    <hr>
                    <input type="submit" value="Add TSH result">
                </form>
        
                <svg width="800" height="400"></svg>
            </div>


        </div>
            
                
                
                
                
            
        </div>
        
        <script type="text/javascript">
            window.globalClient = null
            window.year = 2028
            svg = d3.select("svg")
            margin = 100,
            width = svg.attr("width") - margin, //300
            height = svg.attr("height") - margin //200
            xScale = null
            yScale = null

            function drawPlane() {
                // Step 3
                console.log("plane tsh" + tsh_result)
                
                g = svg.append("g").attr("transform", "translate(" + 100 + "," + 50 + ")");
                
                svg.append('text')
                .attr('x', width/2 + 100)
                .attr('y', 100)
                .attr('text-anchor', 'middle')
                .style('font-family', 'Helvetica')
                .style('font-size', 20)
                .text('TSH over time');
                
                // X label
                svg.append('text')
                .attr('x', width/2 + 100)
                .attr('y', height - 15 + 150)
                .attr('text-anchor', 'middle')
                .style('font-family', 'Helvetica')
                .style('font-size', 12)
                .text('Time');
                
                // Y label
                svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'translate(60,' + height + ')rotate(-90)')
                .style('font-family', 'Helvetica')
                .style('font-size', 12)
                .text('TSH');
            }

            function drawAxises() {
                console.log("axis tsh" + tsh_result)

                tsh_result.forEach(function(d) {
                    d[0] = d3.timeParse("%Y-%m-%d")(d[0]);
                });

                // Step 4 
                xScale = d3.scaleTime().domain(d3.extent(tsh_result, function(d) {
                        return d[0];
                })).range([0, width]);
                yScale = d3.scaleLinear().domain([-4, 10]).range([height, 0]);

                // Step 6
                g.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale));
                
                g.append("g")
                .call(d3.axisLeft(yScale));

            }
                
            function drawData() {
                console.log("data tsh" + tsh_result)

                // Step 7
                svg.append('g')
                .selectAll("dot")
                .data(tsh_result)
                .enter()
                .append("circle")
                .attr("cx", function (d) { return xScale(d[0]); } )
                .attr("cy", function (d) { return yScale(d[1]); } )
                .attr("r", 3)
                .attr("transform", "translate(" + 100 + "," + 100 + ")")
                .style("fill", "#CC0000");

                // Step 8        
                var line = d3.line()
                .x(function(d) { return xScale(d[0]); }) 
                .y(function(d) { return yScale(d[1]); }) 
                .curve(d3.curveMonotoneX)
                
                svg.append("path")
                .datum(tsh_result) 
                .attr("class", "line") 
                .attr("transform", "translate(" + 100 + "," + 100 + ")")
                .attr("d", line)
                .style("fill", "none")
                .style("stroke", "#CC0000")
                .style("stroke-width", "2");
            }

            function addMoreTSH(){
                let observation =
                    {
                        "resourceType": "Observation",
                        "status": "final",
                        "code": {
                            "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "11580-8",
                                    "display": "thyroid stimulating hormone"
                                }
                            ],
                            "text": "thyroid stimulating hormone"
                        },
                        "subject": { "reference": "" },
                        "effectiveDateTime": "",
                        "component": [
                            {
                            "code": {
                                "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "11580-8",
                                    "display": "thyroid stimulating hormone"
                                }
                                ]
                            },
                            "valueQuantity": {
                                "value": 10,
                                "unit": "mIU/L",
                                "system": "http://unitsofmeasure.org",
                                "code": "m[iU]/L"
                            }
                            }
                        ]
                    }  
                observation["subject"]["reference"] = "Patient/" + globalClient.patient.id
                window.year++;
                new_date = window.year + '-01-01'
                observation.effectiveDateTime = new_date
                document.getElementById('obs').innerHTML = new_date
                window.globalClient.create(observation)
                showObservation(globalClient);
            }

            function addMethimazoleMeds(client) {
                let medicationRequest = 
                    {
                        "resourceType": "MedicationRequest",
                        "status": "active",
                        "intent": "order", 
                        "subject": { "reference": "" },
                        "medicationCodeableConcept" : 
                        {
                            "coding": 
                            [
                                {
                                    "system": "http://www.nlm.nih.gov/research/umls/rxnorm",
                                    "code": "197942",                         // 197941
                                    "display": "methimazole 5 MG Oral Tablet" // methimazole 10 MG Oral Tablet 
                                }
                            ]
                        },
                        "authoredOn": "2024-03-30T09:51:38+00:00",
                    }
                medicationRequest["subject"]["reference"] = "Patient/" + client.patient.id
                client.create(medicationRequest)
            }

            function addTSHLab(client) {
                let observation =
                    {
                        "resourceType": "Observation",
                        "status": "final",
                        "code": {
                            "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "11580-8",
                                    "display": "thyroid stimulating hormone"
                                }
                            ],
                            "text": "thyroid stimulating hormone"
                        },
                        "subject": { "reference": "" },
                        "effectiveDateTime": "",
                        "component": [
                            {
                            "code": {
                                "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "11580-8",
                                    "display": "thyroid stimulating hormone"
                                }
                                ]
                            },
                            "valueQuantity": {
                                "value": 0.3,
                                "unit": "mIU/L",
                                "system": "http://unitsofmeasure.org",
                                "code": "m[iU]/L"
                            }
                            }
                        ]
                    }  
                observation["subject"]["reference"] = "Patient/" + client.patient.id

                n = Math.floor(Math.random() * 3 + 3);
                start = new Date(2018, 0, 1)
                end = new Date(2023, 11, 11)
                rd = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
                
                for (i = 0; i < n; i++) {
                    observation.effectiveDateTime = rd.toISOString().split('T')[0]
                    // rd.getFullYear() + "-" + (rd.getMonth()+1) + "-" + rd.getDate(), Math.random()*10
                    observation.component[0].valueQuantity.value = Math.random()*10;
                    console.log('effectiveDateTime = ' + observation.effectiveDateTime)
                    rd.setDate(rd.getDate() - 100);
                    client.create(observation)
                }  
            }

            function showObservation(client) {

                let queryParamsObs = new URLSearchParams();
                queryParamsObs.set('patient', client.patient.id);
                queryParamsObs.set('code', 'http://loinc.org|11580-8');
                queryParamsObs.set('_sort', '-date');

                client.request("Observation?" + queryParamsObs, 
                    {
                        resolveReferences: [ "valueQuantity" ],
                        graph: true
                    }
                )
                // Reject if no Observations are found
                .then(function(data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error("No Observation found for the selected patient");
                    }
                    return data.entry;
                })
                // Render the current patient's Observations (or any error)
                .then(
                    function(obs) {
                        // document.getElementById("obs").innerText = JSON.stringify(obs, null, 4);
                        // document.getElementById("obs").innerText = 
                        // (obs[0]['resource']['effectiveDateTime'] + ":" + obs[0]['resource']['component'][0]['valueQuantity']['value']);  
                        let n = obs.length
                        tsh_result = []
                        for (i = 0; i < n; i++) {
                            tsh_result.push([obs[i]['resource']['effectiveDateTime'], 
                                             obs[i]['resource']['component'][0]['valueQuantity']['value']]);
                        }
                        console.log(tsh_result)
                        drawPlane();
                        drawAxises();
                        drawData();            
                },
                function(error) {
                    document.getElementById("obs").innerText = error.stack;
                }
            );
            }

            FHIR.oauth2.ready().then(function(client) {
                window.globalClient = client
                
                // Render the current patient (or any error)
                client.patient.read().then(
                    function(pt) {
                        // patient_test = JSON.parse(pt)
                        console.log('type of pt = ', pt["name"][0]["given"][0])

                        // document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);
                        // document.getElementById("extended_patient").innerText = pt["name"][0]["given"][0];
                    },
                    function(error) {
                        document.getElementById("patient").innerText = error.stack;
                    }
                );

                addMethimazoleMeds(client);
                addTSHLab(client)

                // Get MedicationRequests for the selected patient
                let queryParamsMeds = new URLSearchParams();
                queryParamsMeds.set('patient', client.patient.id);
                queryParamsMeds.set('code', 'http://www.nlm.nih.gov/research/umls/rxnorm|197942');                
                
                client.request("/MedicationRequest?" + queryParamsMeds, {
                    resolveReferences: [ "medicationReference" ],
                    graph: true
                })
                
                // Reject if no MedicationRequests are found
                .then(function(data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error("No medications found for the selected patient");
                    }
                    return data.entry;
                }) // Render the current patient's medications (or any error)
                .then(
                    function(meds) {
                        // document.getElementById("meds").innerText = JSON.stringify(meds, null, 4);
                        // document.getElementById("meds").innerText = meds[0]['resource']['medicationCodeableConcept']['coding'][0]['display'];
                        document.getElementById("meds").innerText = meds[0]['resource']['medicationCodeableConcept']['coding'][0]['display'];
                    },
                    function(error) {
                        document.getElementById("meds").innerText = error.stack;
                    }
                );
                showObservation(client);
            }).catch(console.error);
        </script>
    </body>
</html>